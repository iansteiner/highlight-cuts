<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highlight Cuts</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* HTMX loading indicator - hidden by default, shown when request is in flight */
        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator,
        .htmx-request.htmx-indicator {
            display: block;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen py-12 px-4 sm:px-6 lg:px-8 text-gray-900">
    <div class="max-w-4xl mx-auto">

        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight sm:text-5xl mb-2">
                Highlight Cuts
            </h1>
            <p class="text-lg text-gray-600">
                Create video highlights from Google Sheets data in seconds.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Main Form Column -->
            <div class="lg:col-span-2 space-y-8">

                <form hx-post="/process" hx-target="#result-area" class="space-y-6">

                    <!-- Card 1: Video Selection -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 p-8">
                        <!-- Video Selection (Team -> Tournament -> Game) -->
                        <div class="space-y-4">
                            <label class="block text-sm font-semibold text-gray-700">Video Selection</label>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Team Select -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Team</label>
                                    <select id="team-select" onchange="updateTournaments()"
                                        class="block w-full rounded-lg border-gray-300 bg-gray-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border appearance-none">
                                        <option value="" disabled selected>Select Team</option>
                                    </select>
                                </div>

                                <!-- Tournament Select -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Tournament</label>
                                    <select id="tournament-select" onchange="updateGames()" disabled
                                        class="block w-full rounded-lg border-gray-300 bg-gray-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border appearance-none disabled:bg-gray-100 disabled:text-gray-400">
                                        <option value="" disabled selected>Select Tournament</option>
                                    </select>
                                </div>

                                <!-- Game Select -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-500 mb-1">Game</label>
                                    <select id="game-select-video" onchange="updateVideoPath()" disabled
                                        class="block w-full rounded-lg border-gray-300 bg-gray-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border appearance-none disabled:bg-gray-100 disabled:text-gray-400">
                                        <option value="" disabled selected>Select Game</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Hidden input for the actual file path sent to server -->
                            <input type="hidden" name="video_filename" id="video-filename-input" required>

                            <p class="text-xs text-gray-500 mt-1 flex items-center">
                                <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Files located in <code>/data/team/tournament/game.mp4</code>
                            </p>
                            <div id="game-table-container" class="mt-3"></div>
                        </div>

                        <script>
                            // Pass the video structure from Python to JS
                            const videoStructure = {{ video_structure | tojson }};

                            const teamSelect = document.getElementById('team-select');
                            const tournamentSelect = document.getElementById('tournament-select');
                            const gameSelect = document.getElementById('game-select-video');
                            const videoInput = document.getElementById('video-filename-input');
                            const gameTableContainer = document.getElementById('game-table-container');

                            // Initialize Teams
                            const teamKeys = Object.keys(videoStructure);
                            if (teamKeys.length === 0) {
                                const notice = document.createElement('p');
                                notice.className = 'text-sm text-red-600 mt-2';
                                notice.textContent = 'No teams found. Check your data directory.';
                                teamSelect.parentNode.appendChild(notice);
                            } else {
                                for (const team of teamKeys) {
                                    const option = document.createElement('option');
                                    option.value = team;
                                    option.textContent = team;
                                    teamSelect.appendChild(option);
                                }
                            }

                            function updateTournaments() {
                                const team = teamSelect.value;
                                localStorage.setItem('selected-team', team);
                                localStorage.removeItem('selected-tournament');
                                localStorage.removeItem('selected-game');

                                tournamentSelect.innerHTML = '<option value="" disabled selected>Select Tournament</option>';
                                gameSelect.innerHTML = '<option value="" disabled selected>Select Game</option>';
                                tournamentSelect.disabled = true;
                                gameSelect.disabled = true;
                                videoInput.value = '';
                                gameTableContainer.innerHTML = '';

                                if (team && videoStructure[team]) {
                                    for (const tournament in videoStructure[team]) {
                                        const option = document.createElement('option');
                                        option.value = tournament;
                                        option.textContent = tournament;
                                        tournamentSelect.appendChild(option);
                                    }
                                    tournamentSelect.disabled = false;
                                }
                            }

                            function updateGames() {
                                const team = teamSelect.value;
                                const tournament = tournamentSelect.value;
                                localStorage.setItem('selected-tournament', tournament);
                                localStorage.removeItem('selected-game');

                                gameSelect.innerHTML = '<option value="" disabled selected>Select Game</option>';
                                gameSelect.disabled = true;
                                videoInput.value = '';
                                gameTableContainer.innerHTML = '';

                                if (team && tournament && videoStructure[team][tournament]) {
                                    const games = videoStructure[team][tournament];
                                    gameSelect.innerHTML = '<option value="" disabled selected>Select Game</option>';
                                    games.forEach(game => {
                                        const option = document.createElement('option');
                                        option.value = game.path; // Store the relative path as value
                                        option.textContent = game.title || game.name;
                                        option.dataset.streamUrl = game.stream_url || '';
                                        gameSelect.appendChild(option);
                                    });
                                    gameSelect.disabled = false;

                                    // Render table with watch links
                                    const rows = games.map(g => {
                                        const streamCell = g.stream_url
                                            ? `<a href="${g.stream_url}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 text-sm font-medium">Watch</a>`
                                            : `<span class="text-gray-400 text-sm">No link</span>`;
                                        return `
                                            <tr class="border-b last:border-b-0">
                                                <td class="py-2 px-3 text-sm text-gray-800">${g.title || g.name}</td>
                                                <td class="py-2 px-3 text-xs text-gray-500">${g.suffix || ''}</td>
                                                <td class="py-2 px-3">${streamCell}</td>
                                                <td class="py-2 px-3 text-right">
                                                    <button type="button" class="text-blue-600 hover:text-blue-800 text-sm font-medium" data-path="${g.path.replace(/\"/g, '&quot;')}" onclick="selectGameFromTable(this.dataset.path)">Use</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('');
                                    gameTableContainer.innerHTML = `
                                        <div class="mt-3 border rounded-lg overflow-hidden">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                                                    <tr>
                                                        <th class="py-2 px-3 text-left">Game</th>
                                                        <th class="py-2 px-3 text-left">Ext</th>
                                                        <th class="py-2 px-3 text-left">Watch</th>
                                                        <th class="py-2 px-3 text-right">Select</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="bg-white divide-y divide-gray-100">
                                                    ${rows}
                                                </tbody>
                                            </table>
                                        </div>
                                    `;
                                }
                            }

                            function updateVideoPath() {
                                const team = teamSelect.value;
                                const tournament = tournamentSelect.value;
                                const gamePath = gameSelect.value; // This is the full relative path
                                localStorage.setItem('selected-game', gamePath);

                                videoInput.value = gamePath; // The input already expects the full path
                            }

                            window.selectGameFromTable = function (gamePath) {
                                // Set dropdown and hidden input from table button
                                const option = Array.from(gameSelect.options).find(opt => opt.value === gamePath);
                                if (option) {
                                    gameSelect.value = gamePath;
                                    updateVideoPath();
                                } else {
                                    videoInput.value = gamePath;
                                    localStorage.setItem('selected-game', gamePath);
                                }
                            };

                            // Restore selections from localStorage on page load
                            window.addEventListener('DOMContentLoaded', () => {
                                const savedTeam = localStorage.getItem('selected-team');
                                const savedTournament = localStorage.getItem('selected-tournament');
                                const savedGame = localStorage.getItem('selected-game');

                                if (savedTeam && videoStructure[savedTeam]) {
                                    teamSelect.value = savedTeam;
                                    updateTournaments(); // Populate tournaments based on saved team

                                    if (savedTournament && videoStructure[savedTeam][savedTournament]) {
                                        // Use setTimeout to ensure DOM updates from updateTournaments have rendered
                                        setTimeout(() => {
                                            tournamentSelect.value = savedTournament;
                                            updateGames(); // Populate games based on saved tournament

                                            if (savedGame) {
                                                // Check if the saved game path exists in the current game options
                                                const gameExists = Array.from(gameSelect.options).some(option => option.value === savedGame);
                                                if (gameExists) {
                                                    setTimeout(() => {
                                                        gameSelect.value = savedGame;
                                                        updateVideoPath(); // Set the hidden input
                                                    }, 0);
                                                } else {
                                                    // If saved game doesn't exist, clear it from storage
                                                    localStorage.removeItem('selected-game');
                                                }
                                            }
                                        }, 0);
                                    } else {
                                        // If saved tournament doesn't exist, clear it and subsequent selections
                                        localStorage.removeItem('selected-tournament');
                                        localStorage.removeItem('selected-game');
                                    }
                                } else {
                                    // If saved team doesn't exist, clear all selections
                                    localStorage.removeItem('selected-team');
                                    localStorage.removeItem('selected-tournament');
                                    localStorage.removeItem('selected-game');
                                }
                            });
                        </script>
                    </div>

                    <!-- Card 2: Google Sheet, Selection, and Actions -->
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 p-8 space-y-8">

                        <!-- Google Sheet URL -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Google Sheet URL</label>
                            <div class="flex gap-2">
                                <input id="sheet-url" type="text" name="sheet_url" list="cached-sheets"
                                    class="block w-full rounded-lg border-gray-300 bg-gray-50 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border"
                                    placeholder="https://docs.google.com/spreadsheets/..." hx-post="/parse-sheet"
                                    hx-trigger="change" hx-target="#sheet-status" required>
                                <datalist id="cached-sheets">
                                    {% for sheet in cached_sheets %}
                                    <option value="{{ sheet.original_url }}" label="{{ sheet.sheet_name }}">{{ sheet.sheet_name }}</option>
                                    {% endfor %}
                                </datalist>
                                <button type="button" hx-post="/parse-sheet" hx-include="[name='sheet_url']"
                                    hx-target="#sheet-status"
                                    class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition flex items-center gap-2 shadow-sm font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                <button type="button" onclick="openSheetInNewTab()"
                                    class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 hover:text-blue-600 transition flex items-center gap-2 shadow-sm font-medium"
                                    title="Open sheet in new tab">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14 3h7m0 0v7m0-7L10 14M5 5v14a2 2 0 002 2h10" />
                                    </svg>
                                </button>
                            </div>
                            <div id="sheet-status" class="text-sm mt-2 min-h-[1.5rem]"></div>
                            {% if cached_sheets %}
                            <p class="text-xs text-gray-500 mt-2 flex items-center">
                                <svg class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Click the input to see {{ cached_sheets|length }} recent sheet(s)
                            </p>
                            {% endif %}
                        </div>

                        <!-- Game/Player Selection -->
                        <div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <!-- Hidden Inputs for Selection -->
                                <input type="hidden" id="game-input" name="game" required>
                                <input type="hidden" id="player-input" name="player" required>

                                <!-- Selection Table Container -->
                                <div id="selection-table-container" class="mt-2">
                                    <div
                                        class="text-sm text-gray-500 italic text-center p-4 border rounded-lg bg-gray-50">
                                        Enter a Sheet URL to load available games and players.
                                    </div>
                                </div>
                            </div>

                            <script>
                                function selectSelection(element, game, player) {
                                    // Update hidden inputs
                                    document.getElementById('game-input').value = game;
                                    document.getElementById('player-input').value = player;

                                    // Visual feedback
                                    // Remove highlight from all rows
                                    const rows = document.querySelectorAll('#selection-table-container tr');
                                    rows.forEach(r => {
                                        r.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-500');
                                        r.classList.add('hover:bg-gray-50');
                                    });

                                    // Add highlight to selected row
                                    element.classList.remove('hover:bg-gray-50');
                                    element.classList.add('bg-blue-100', 'ring-2', 'ring-blue-500');
                                }
                            </script>
                        </div>

                        <!-- Actions (Generate & Clips) -->
                        <div>
                            <!-- Submit Button -->
                            <button type="submit" id="generate-btn"
                                onclick="return validateSelection()"
                                class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 mb-4">
                                Generate Highlights
                            </button>
                            <script>
                                function validateSelection() {
                                    const game = document.getElementById('game-input').value;
                                    const player = document.getElementById('player-input').value;
                                    const resultArea = document.getElementById('result-area');

                                    if (!game || !game.trim()) {
                                        resultArea.innerHTML = `
                                            <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                                                <div class="flex items-center gap-2">
                                                    <svg class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                    <span class="text-red-700 font-medium">Error: No game selected. Please select a game and player from the table above.</span>
                                                </div>
                                            </div>
                                        `;
                                        return false;
                                    }

                                    if (!player || !player.trim()) {
                                        resultArea.innerHTML = `
                                            <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                                                <div class="flex items-center gap-2">
                                                    <svg class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                    <span class="text-red-700 font-medium">Error: No player selected. Please select a game and player from the table above.</span>
                                                </div>
                                            </div>
                                        `;
                                        return false;
                                    }

                                    return true;
                                }
                            </script>

                            <!-- Clips Table -->
                            <div id="clips-table" class="mt-4"></div>
                        </div>
                    </div>
                </form>

                <!--
                Debug Log Card (commented out for production use)
                <div class="mt-8 bg-gray-900 rounded-2xl shadow-xl overflow-hidden border border-gray-800 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-200 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                            </svg>
                            FFmpeg Debug Log
                        </h3>
                        <button hx-get="/debug-log" hx-target="#debug-log-content"
                            class="text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-1 rounded border border-gray-700 transition">
                            Refresh Log
                        </button>
                    </div>
                    <div id="debug-log-content" hx-get="/debug-log" hx-trigger="load, every 5s" class="min-h-[100px]">
                        <div class="text-gray-500 italic text-sm">Waiting for logs...</div>
                    </div>
                </div>
                -->

                <!-- Result Area -->
                <div id="result-area" class="mt-6"></div>

                <!-- Video Player -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Player (Beta)</h3>
                    <div id="video-player-container" class="bg-gray-900 rounded-xl border border-gray-800 min-h-[120px]"></div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="space-y-8">

                <!-- Instructions Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
                        <h3 class="text-lg font-semibold text-blue-900 flex items-center">
                            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            How to use
                        </h3>
                    </div>
                    <div class="p-6 text-sm text-gray-600 space-y-4">
                        <div class="flex gap-3">
                            <span
                                class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">1</span>
                            <p>Select a video file from the <code>data/</code> directory.</p>
                        </div>
                        <div class="flex gap-3">
                            <span
                                class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">2</span>
                            <p>Paste your Google Sheet URL (must be shared publicly).</p>
                        </div>
                        <div class="flex gap-3">
                            <span
                                class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">3</span>
                            <p>Select the Game and Player.</p>
                        </div>
                        <div class="flex gap-3">
                            <span
                                class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">4</span>
                            <p>Click <strong>Generate Highlights</strong> and wait for processing.</p>
                        </div>

                        <div class="pt-4 border-t border-gray-100">
                            <a href="https://docs.google.com/spreadsheets/d/1rydB9tbIIL-CsTYPSPwWzabxe_CRKXeCfH7HCcCFoxM/edit?usp=sharing"
                                target="_blank"
                                class="text-blue-600 hover:text-blue-800 font-medium flex items-center text-xs">
                                <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                                View Example Google Sheet
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Recent Files Card -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="text-lg font-semibold text-gray-800">Generated Files</h3>
                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded-full">Auto-refresh</span>
                    </div>
                    <div id="file-list" hx-get="/files" hx-trigger="load, every 5s"
                        class="max-h-[500px] overflow-y-auto">
                        <div class="p-6 text-center text-gray-500 text-sm">Loading...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Highlight Cuts: Script loaded');
            const sheetInput = document.querySelector('input[name="sheet_url"]');

            if (!sheetInput) {
                console.error('Highlight Cuts: Sheet input not found');
                return;
            }

            // Restore from localStorage
            const cachedUrl = localStorage.getItem('highlight_cuts_sheet_url');
            console.log('Highlight Cuts: Cached URL:', cachedUrl);

            if (cachedUrl) {
                sheetInput.value = cachedUrl;
                console.log('Highlight Cuts: Restored value to input');
                // Trigger change event for HTMX
                htmx.trigger(sheetInput, 'change');
            }

            function saveToStorage(e) {
                console.log('Highlight Cuts: Saving to storage:', e.target.value);
                localStorage.setItem('highlight_cuts_sheet_url', e.target.value);
            }

            // Save to localStorage on input and change
            sheetInput.addEventListener('input', saveToStorage);
            sheetInput.addEventListener('change', saveToStorage);
        });

        function openSheetInNewTab() {
            const input = document.getElementById('sheet-url');
            if (!input || !input.value.trim()) {
                alert('Enter a Google Sheet URL first.');
                return;
            }
            window.open(input.value.trim(), '_blank');
        }
    </script>
</body>

</html>
